<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Facts - STARK book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../././mdbook-admonish.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Foundations</li><li class="chapter-item expanded "><a href="../math/finite_fields.html"><strong aria-hidden="true">2.</strong> Finite Fields</a></li><li class="chapter-item expanded "><a href="../math/lde.html"><strong aria-hidden="true">3.</strong> Functions and low-degree extension</a></li><li class="chapter-item expanded "><a href="../math/extension_fields.html"><strong aria-hidden="true">4.</strong> Extension Fields</a></li><li class="chapter-item expanded "><a href="../math/code_theory.html"><strong aria-hidden="true">5.</strong> Code Theory</a></li><li class="chapter-item expanded affix "><li class="part-title">Circuits</li><li class="chapter-item expanded "><a href="../air/air.html"><strong aria-hidden="true">6.</strong> The AIR Arithmetization</a></li><li class="chapter-item expanded affix "><li class="part-title">STARK</li><li class="chapter-item expanded "><a href="../stark/overview.html"><strong aria-hidden="true">7.</strong> STARK</a></li><li class="chapter-item expanded "><a href="../fri/fri.html"><strong aria-hidden="true">8.</strong> FRI</a></li><li class="chapter-item expanded affix "><li class="part-title">Cairo: STARK's zkVM</li><li class="chapter-item expanded "><a href="../cairo/cairo.html"><strong aria-hidden="true">9.</strong> Cairo</a></li><li class="chapter-item expanded "><a href="../cairo/memory.html"><strong aria-hidden="true">10.</strong> Cairo public memory</a></li><li class="chapter-item expanded "><a href="../cairo/bootloader.html"><strong aria-hidden="true">11.</strong> Bootloader</a></li><li class="chapter-item expanded "><a href="../cairo/builtins.html"><strong aria-hidden="true">12.</strong> Builtins and Layouts</a></li><li class="chapter-item expanded affix "><li class="part-title">Starkex: Verifying Cairo programs on Ethereum</li><li class="chapter-item expanded "><a href="../starkex/starkex.html"><strong aria-hidden="true">13.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../starkex/facts.html" class="active"><strong aria-hidden="true">14.</strong> Facts</a></li><li class="chapter-item expanded "><a href="../starkex/cairo.html"><strong aria-hidden="true">15.</strong> Verifying Cairo proofs</a></li><li class="chapter-item expanded "><a href="../starkex/bootloader.html"><strong aria-hidden="true">16.</strong> Bootloader</a></li><li class="chapter-item expanded affix "><li class="part-title">Starknet</li><li class="chapter-item expanded "><a href="../starknet/starknet.html"><strong aria-hidden="true">17.</strong> Starknet</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">STARK book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://www.github.com/zksecurity/stark-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="fact-registry"><a class="header" href="#fact-registry">Fact Registry</a></h1>
<p>The <a href="https://github.com/starkware-libs/starkex-contracts/">Starkex contracts</a> implement the verifier side of the <a href="https://starkware.co/resource/joining-forces-sharp/">SHARP service</a>. 
In other words, when people create proofs using the <a href="https://starkware.co/resource/joining-forces-sharp/">SHARP service</a>, they can get them verified on Ethereum using the <a href="https://github.com/starkware-libs/starkex-contracts/">Starkex contracts</a>.</p>
<p>First, let’s introduce what a fact is: a fact can be any computation that was computed by some logic in the smart contract. For example, a fact can be: “<em>we successfully verified a proof for this Cairo program and these public inputs</em>”.
This example is actually the main fact that Starkex will register for the different applications making use of it.
But internally, other facts are used whenever a computation (like verifying a proof) is split in different transactions that need to produce a snapshot of what has been done so far and resume from other snapshots. This is explained in more details in the <a href="./cairo.html">Verifying Cairo proofs</a> section.</p>
<p>A fact is represented (or authenticated) by a hash of it. As such, it is important that different applications or different contexts use “different” hash functions not to have collisions. This can be done by adding some domain separation string to the hash function.</p>
<h2 id="the-fact-registry"><a class="header" href="#the-fact-registry">The Fact Registry</a></h2>
<p>Let’s introduce the smart contract in charge of these facts, <a href="https://github.com/starkware-libs/starkex-contracts/blob/aecf37f2278b2df233edd13b686d0aa9462ada02/scalable-dex/contracts/src/components/FactRegistry.sol">FactRegistry.sol</a>:</p>
<pre><code class="language-js">contract FactRegistry is IQueryableFactRegistry {
    // Mapping: fact hash -&gt; true.
    mapping(bytes32 =&gt; bool) private verifiedFact
</code></pre>
<p>As you can see, facts are just tracked via a hashmap. Registering a fact is such straightfoward:</p>
<pre><code class="language-js">    function registerFact(bytes32 factHash) internal {
        // This function stores the fact hash in the mapping.
        verifiedFact[factHash] = true;
</code></pre>
<p>As well as checking if a fact has been registered:</p>
<pre><code class="language-js">    function isValid(bytes32 fact) external view override returns (bool) {
        return _factCheck(fact);
    }
</code></pre>
<h2 id="example-of-registering-a-fact"><a class="header" href="#example-of-registering-a-fact">Example of registering a fact</a></h2>
<p>An example of registering a fact can be seen, for example at the end of a proof verification. In <a href="https://github.com/starkware-libs/starkex-contracts/blob/aecf37f2278b2df233edd13b686d0aa9462ada02/evm-verifier/solidity/contracts/gps/GpsStatementVerifier.sol#L71">GpsStatementVerifier.sol:verifyProofAndRegister()</a>:</p>
<pre><code class="language-js">    function verifyProofAndRegister(
        uint256[] calldata proofParams,
        uint256[] calldata proof,
        uint256[] calldata taskMetadata,
        uint256[] calldata cairoAuxInput,
        uint256 cairoVerifierId
    ) external {
        // TRUNCATED...

        registerGpsFacts(taskMetadata, publicMemoryPages, cairoAuxInput[OFFSET_OUTPUT_BEGIN_ADDR]);
    }
</code></pre>
<p>where <code>registerGpsFacts</code> is defined as:</p>
<pre><code class="language-js">    function registerGpsFacts(
        uint256[] calldata taskMetadata,
        uint256[] memory publicMemoryPages,
        uint256 outputStartAddress
    ) internal {
        // TRUNCATED...

        // Register the fact for each task.
        for (task = 0; task &lt; nTasks; task++) {
            // TRUNCATED...

            bytes32 fact = keccak256(abi.encode(programHash, programOutputFact));

            // TRUNCATED...
            registerFact(fact);

            // TRUNCATED...
        }

        // TRUNCATED...
    }
</code></pre>
<h2 id="example-of-checking-if-a-fact-is-registered"><a class="header" href="#example-of-checking-if-a-fact-is-registered">Example of checking if a fact is registered</a></h2>
<p><a href="https://book.starknet.io/">Starknet</a> is the main application making use of SHARP, and as such their smart contract uses the fact registry directly.</p>
<p>The main function of Starknet is <a href="https://github.com/mimoo/starknet-contracts/blob/main/contracts/Starknet.sol#L176"><code>updateState()</code></a>, which updates the state based on proofs that have been verified:</p>
<pre><code class="language-js">    function updateState(
        int256 sequenceNumber,
        uint256[] calldata programOutput,
        uint256 onchainDataHash,
        uint256 onchainDataSize
    ) external onlyOperator {
        // TRUNCATED...

        bytes32 sharpFact = keccak256(
            abi.encode(programHash(), stateTransitionFact)
        );
        require(
            IFactRegistry(verifier()).isValid(sharpFact),
            &quot;NO_STATE_TRANSITION_PROOF&quot;
        );

        // TRUNCATED...
</code></pre>
<p>Another example we can look at is within a proof verification. As explained in <a href="./cairo.html">Verifying a Cairo proof</a>, a proof verification is split in multiple transactions.</p>
<p>For example, Merkle membership proofs are verified in segregated transactions, and then the fact that they were verified is used within another execution:</p>
<pre><code class="language-js">    function verifyMerkle(
        uint256[] memory merkleView,
        uint256[] memory initialMerkleQueue,
        uint256 height,
        uint256 expectedRoot
    ) public {
        // TRUNCATED...
        
        bytes32 resRoot = verifyMerkle(channelPtr, merkleQueuePtr, bytes32(expectedRoot), nQueries);
        bytes32 factHash;
        assembly {
            // Append the resulted root (should be the return value of verify) to dataToHashPtr.
            mstore(dataToHashPtr, resRoot)
            // Reset dataToHashPtr.
            dataToHashPtr := add(channelPtr, 0x20)
            factHash := keccak256(dataToHashPtr, add(mul(nQueries, 0x40), 0x20))
        }

        registerFact(factHash);
    }
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../starkex/starkex.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../starkex/cairo.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../starkex/starkex.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../starkex/cairo.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </div>
    </body>
</html>
